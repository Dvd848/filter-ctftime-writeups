{% extends "base.html" %}
{% set active_page = "filter" %}

{% block content %}
    <h1>Filter the Feed</h1>
    <div id="filter">
        <p>
            Enter the CTF Names you'd like to see in your feed.
        </p>
        <div class="rounded border border-light p-3 text-center" id="ctf_names_wrapper">
            <div id="ctf_names">
                <img src="{{ url_for('static',filename='images/ajax-loader.gif') }}" alt="Loading..." id="ajax_loader" />
            </div>
            <button class="btn btn-primary" id="add_button">+</button>
        </div>
    </div>
    
    <div id="login">
        <div id="firebaseui-auth-container"></div>
    </div>

<script>
const MAX_CTF_NAMES = 20;
firebase.auth().onAuthStateChanged((user) => {
    if (user) 
    {
        // User is signed in

        const uid = user.uid;
        /*
        firebase.database().ref('data/' + uid).set({
            ctf_names: "Ledger" + "‚êû" + "JISCTF"
        });
        */
        $("#filter").show();
        $("#login").hide();

        firebase.database().ref(`/data/${uid}/ctf_names`).once('value').then((snapshot) => {
            $("#ajax_loader").hide();

            const ctf_names = snapshot.val()?.split("‚êû") || [];

            const create_input_wrapper = function(){ 
                const input_wrapper = $(`<div class="input-group mb-3 ctf_name_entry">
                    <input type="text" class="form-control ctf_name_input" placeholder="CTF Name" aria-label="CTF Name" aria-describedby="basic-addon2">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary btn-danger text-white remove_ctf_name" type="button">üóô</button>
                    </div>
                </div>`);
                input_wrapper.find(".remove_ctf_name").click(function(){
                    input_wrapper.remove(); 
                    show_hide_add_button();
                });
                return input_wrapper;
            };

            ctf_names.forEach(ctf_name => {
                const input_wrapper = create_input_wrapper();
                input_wrapper.find(".ctf_name_input").val(ctf_name);
                $("#ctf_names").append(input_wrapper);
            });

            if (ctf_names.length == 0)
            {
                $("#ctf_names").append(create_input_wrapper());
            }

            const ctf_names_wrapper = $("#ctf_names_wrapper");
            const add_button = $('#add_button');
            add_button.click(function(){
                const input_wrapper = create_input_wrapper();
                $("#ctf_names").append(input_wrapper);
                
                show_hide_add_button();
                
                ctf_names_wrapper.scrollTop(ctf_names_wrapper.prop("scrollHeight"));
            });

            const show_hide_add_button = function() {
                ($(".ctf_name_input").length < MAX_CTF_NAMES) ? add_button.show() : add_button.hide();   
            };

            show_hide_add_button();
            
            
        });
    } 
    else 
    {
        // User is signed out
        
        var uiConfig = 
        {
            callbacks: {
                signInSuccessWithAuthResult: function(authResult, redirectUrl) 
                {
                    // User successfully signed in.
                    // Return type determines whether we continue the redirect automatically
                    // or whether we leave that to developer to handle.
                    $("#login").hide();
                    return false;
                },
                uiShown: function() 
                {
                    // The widget is rendered.
                    $(".firebaseui-title").text("Sign in / Sign up with email")
                }
            },
            'credentialHelper': firebaseui.auth.CredentialHelper.NONE,
            // Will use popup for IDP Providers sign-in flow instead of the default, redirect.
            //signInFlow: 'popup',
            //signInSuccessUrl: '/filter',
            signInOptions: [
                {
                    provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
                    requireDisplayName: false
                }
            ],
            // Terms of service url.
            //tosUrl: '<your-tos-url>',
            // Privacy policy url.
            //privacyPolicyUrl: '<your-privacy-policy-url>'
        };

        $("#filter").hide();
        $("#login").show();
        $("#ajax_loader").show();
        $("#filter .ctf_name_entry").remove();

        const ui = firebaseui.auth.AuthUI.getInstance() || new firebaseui.auth.AuthUI(firebase.auth());
        ui.start('#firebaseui-auth-container', uiConfig);
        
    }
});

</script>
{% endblock %}